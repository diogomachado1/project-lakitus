version: '3.7'
services:
  game-service:
      image: diogo8machado/game-service
      environment: 
        - MONGO_URL: /run/secrets/mongo-url
        - RABBIT_HOST: rabbit
        - RABBIT_USER: /run/secrets/rabbit-user
        - RABBIT_PASSWORD: /run/secrets/rabbit-password
        - NEW_RELIC_APP_NAME: game-api
        - NEW_RELIC_LICENSE_KEY: /run/secrets/new-relic-token
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.rabbit.rule=Host(`api.leari.xyz`)"
        - "traefik.http.routers.rabbit.entrypoints=websecure"
        - "traefik.http.routers.rabbit.tls.certresolver=myresolver"
        - "traefik.http.services.myservice.loadbalancer.server.port=3000"
      secret:
        - mongo-url
        - rabbit-user
        - rabbit-password
        - new-relic-token
  rabbit:
      image: rabbitmq:management-alpine
      volumes:
        - "rabbitmq:/var/lib/rabbitmq/mnesia"
      ports:
        - 15672:15672
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.rabbit.rule=Host(`mrabbit.leari.xyz`)"
        - "traefik.http.routers.rabbit.entrypoints=websecure"
        - "traefik.http.routers.rabbit.tls.certresolver=myresolver"
        - "traefik.http.services.myservice.loadbalancer.server.port=15672"
volumes:
  rabbitmq: